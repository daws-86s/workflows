name: NON-PROD Pipeline

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      environment:
        required: true
        type: string
permissions:
  contents: read
  statuses: read

jobs:
  non-prod-gate:
    runs-on: self-hosted

    steps:
      - name: Compute short commit
        id: commit
        run: |
          SHORT_SHA=${{ inputs.version }}
          SHORT_SHA=${SHORT_SHA:0:9}
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Short commit: $SHORT_SHA"

      - name: Check required commit statuses
        id: gate
        shell: bash
        run: |
          echo "üîç Checking commit statuses for ${{ inputs.version }}"

          REQUIRED_CONTEXTS=(
            "DEV_DEPLOY"
            "DOCKER_BUILD"
            "UNIT_TESTS"
            "SECURITY_CHECK"
          )

          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/commits/${{ inputs.version }}/statuses")

          FAILED=0

          for CONTEXT in "${REQUIRED_CONTEXTS[@]}"; do
            STATE=$(echo "$RESPONSE" | jq -r \
              ".[] | select(.context == \"$CONTEXT\") | .state" | head -n 1)

            if [ -z "$STATE" ]; then
              echo "‚ùå $CONTEXT ‚Üí status missing"
              FAILED=1
            elif [ "$STATE" != "success" ]; then
              echo "‚ùå $CONTEXT ‚Üí $STATE"
              FAILED=1
            else
              echo "‚úÖ $CONTEXT ‚Üí success"
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            echo "üö´ UAT gate failed"
            exit 1
          fi

          echo "üéâ All required checks passed"